import { useState, useEffect, useRef, useCallback } from 'react';
import PropTypes from 'prop-types';
import { Play, RotateCcw, GripHorizontal } from 'lucide-react';
import CodeEditor from './CodeEditor';
import ConsolePanel from './ConsolePanel';
import InputPanel from './InputPanel';
import EdgeCasesPanel from './EdgeCasesPanel';
import Timer from './Timer';

const DEFAULT_JAVA_TEMPLATE = `import java.util.*;

class Solution {
    // Write your solution method here
    public int[] twoSum(int[] nums, int target) {
        // Your code here
        return new int[]{};
    }
}`;

function CodePanel({ problemId, onRunCode, edgeCases, onGenerateEdgeCases, isGeneratingEdgeCases, autoGeneratedInput, functionSignature }) {
  // Initialize code with function signature if available
  const initialCode = functionSignature
    ? `import java.util.*;\n\nclass Solution {\n    ${functionSignature} {\n        // Write your code here\n        \n    }\n}`
    : DEFAULT_JAVA_TEMPLATE;
    
  const [code, setCode] = useState(initialCode);
  const [stdin, setStdin] = useState('');
  const [activeTab, setActiveTab] = useState('console');
  const [isRunning, setIsRunning] = useState(false);
  const [output, setOutput] = useState('');
  const [error, setError] = useState('');
  const [timedOut, setTimedOut] = useState(false);
  
  // Resizable panel state
  const [editorHeight, setEditorHeight] = useState(60); // percentage
  const [isDragging, setIsDragging] = useState(false);
  const containerRef = useRef(null);

  // Update code when functionSignature is received (after AI fetches description)
  useEffect(() => {
    if (functionSignature) {
      // Only update if code hasn't been modified by user (still matches default or empty template)
      const isUsingDefaultTemplate = code === DEFAULT_JAVA_TEMPLATE || 
        code === `import java.util.*;\n\nclass Solution {\n    // Write your solution method here\n    public int[] twoSum(int[] nums, int target) {\n        // Your code here\n        return new int[]{};\n    }\n}`;
      
      if (isUsingDefaultTemplate) {
        const newCode = `import java.util.*;\n\nclass Solution {\n    ${functionSignature} {\n        // Write your code here\n        \n    }\n}`;
        setCode(newCode);
      }
    }
  }, [functionSignature]);

  // Auto-populate stdin when edge cases are generated
  useEffect(() => {
    if (autoGeneratedInput && autoGeneratedInput.trim()) {
      setStdin(autoGeneratedInput);
    }
  }, [autoGeneratedInput]);

  // Handle mouse move for resizing
  const handleMouseMove = useCallback((e) => {
    if (!isDragging || !containerRef.current) return;
    
    const container = containerRef.current;
    const containerRect = container.getBoundingClientRect();
    const headerHeight = 40; // Approximate header height
    const availableHeight = containerRect.height - headerHeight;
    const mouseY = e.clientY - containerRect.top - headerHeight;
    
    // Calculate percentage (clamp between 20% and 80%)
    let newHeight = (mouseY / availableHeight) * 100;
    newHeight = Math.max(20, Math.min(80, newHeight));
    
    setEditorHeight(newHeight);
  }, [isDragging]);

  // Handle mouse up to stop dragging
  const handleMouseUp = useCallback(() => {
    setIsDragging(false);
    document.body.style.cursor = 'default';
    document.body.style.userSelect = 'auto';
  }, []);

  // Add/remove global event listeners for dragging
  useEffect(() => {
    if (isDragging) {
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
      document.body.style.cursor = 'row-resize';
      document.body.style.userSelect = 'none';
    } else {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    }
    
    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
  }, [isDragging, handleMouseMove, handleMouseUp]);

  const handleRunCode = async () => {
    setIsRunning(true);
    setOutput('');
    setError('');
    setTimedOut(false);

    try {
      const result = await onRunCode(code, stdin, problemId);
      
      if (result.timedOut) {
        setTimedOut(true);
        setOutput(result.stdout || '');
        setError(`Execution timed out after ${result.timeout}ms`);
      } else {
        setOutput(result.stdout || result.output || '');
        if (result.stderr) {
          setError(result.stderr);
        }
      }
    } catch (err) {
      setError(err.message || 'Failed to execute code');
    } finally {
      setIsRunning(false);
    }
  };

  const handleReset = () => {
    const resetCode = functionSignature
      ? `import java.util.*;\n\nclass Solution {\n    ${functionSignature} {\n        // Write your code here\n        \n    }\n}`
      : DEFAULT_JAVA_TEMPLATE;
      
    setCode(resetCode);
    setStdin('');
    setOutput('');
    setError('');
    setTimedOut(false);
  };

  const tabs = [
    { id: 'console', label: 'Output' },
    { id: 'input', label: 'Input' },
    { id: 'edgecases', label: 'Edge Cases', badge: edgeCases?.length || 0 }
  ];

  return (
    <div ref={containerRef} className="h-full flex flex-col bg-dark-900 border border-dark-800 overflow-hidden">
      {/* Header */}
      <div className="flex items-center justify-between px-3 py-1.5 border-b border-dark-800 bg-dark-900 shrink-0">
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-dark-400">Language:</span>
            <div className="px-2 py-1 bg-dark-800 rounded text-xs font-medium text-white border border-dark-700">
              Java
            </div>
          </div>
          
          {/* Timer */}
          <Timer autoStart={true} />
        </div>

        <div className="flex items-center gap-2">
          <button
            onClick={handleReset}
            className="px-2 py-1 text-xs text-dark-400 hover:text-white bg-dark-800 hover:bg-dark-700 rounded transition-colors flex items-center gap-1"
            title="Reset to default template"
          >
            <RotateCcw className="w-4 h-4" />
            Reset
          </button>
          <button
            onClick={handleRunCode}
            disabled={isRunning}
            className="px-3 py-1 bg-brand-orange hover:bg-orange-600 disabled:bg-dark-700 disabled:text-dark-500 text-white rounded font-medium text-xs transition-colors flex items-center gap-1.5 disabled:cursor-not-allowed"
          >
            {isRunning ? (
              <>
                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                Running...
              </>
            ) : (
              <>
                <Play className="w-4 h-4 fill-current" />
                Run Code
              </>
            )}
          </button>
        </div>
      </div>

      {/* Code Editor - Resizable */}
      <div 
        className="min-h-0 overflow-hidden"
        style={{ height: `${editorHeight}%` }}
      >
        <CodeEditor value={code} onChange={setCode} language="java" />
      </div>

      {/* Draggable Divider */}
      <div 
        className="h-2 bg-dark-800 border-y border-dark-700 cursor-row-resize flex items-center justify-center hover:bg-dark-700 transition-colors shrink-0 group"
        onMouseDown={() => setIsDragging(true)}
      >
        <GripHorizontal className="w-4 h-4 text-dark-500 group-hover:text-dark-300" />
      </div>

      {/* Bottom Panel with Tabs - Resizable */}
      <div 
        className="flex flex-col min-h-0 overflow-hidden"
        style={{ height: `${100 - editorHeight}%` }}
      >
        {/* Tab Headers */}
        <div className="flex items-center border-b border-dark-800 bg-dark-900 shrink-0">
          {tabs.map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`px-4 py-2 text-sm font-medium transition-colors border-b-2 ${
                activeTab === tab.id
                  ? 'border-brand-orange text-white bg-dark-800/50'
                  : 'border-transparent text-dark-400 hover:text-dark-200 hover:bg-dark-800/30'
              }`}
            >
              {tab.label}
              {tab.badge !== undefined && tab.badge > 0 && (
                <span className="ml-2 px-1.5 py-0.5 bg-brand-orange/20 text-brand-orange text-xs rounded-full">
                  {tab.badge}
                </span>
              )}
            </button>
          ))}
        </div>

        {/* Tab Content */}
        <div className="flex-1 min-h-0 overflow-hidden">
          {activeTab === 'console' && (
            <ConsolePanel 
              output={output} 
              error={error} 
              timedOut={timedOut} 
              isLoading={isRunning} 
              testCases={edgeCases}
            />
          )}
          {activeTab === 'input' && (
            <InputPanel value={stdin} onChange={setStdin} />
          )}
          {activeTab === 'edgecases' && (
            <EdgeCasesPanel
              edgeCases={edgeCases}
              isGenerating={isGeneratingEdgeCases}
              onGenerate={onGenerateEdgeCases}
              onCopyInput={(input) => setStdin(input)}
            />
          )}
        </div>
      </div>
    </div>
  );
}

CodePanel.propTypes = {
  problemId: PropTypes.string.isRequired,
  onRunCode: PropTypes.func.isRequired,
  edgeCases: PropTypes.array,
  onGenerateEdgeCases: PropTypes.func,
  isGeneratingEdgeCases: PropTypes.bool,
  autoGeneratedInput: PropTypes.string,
  functionSignature: PropTypes.string
};

export default CodePanel;

